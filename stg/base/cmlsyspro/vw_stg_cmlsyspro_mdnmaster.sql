with src as (
    select 
        *   
         ,'{{source('cmlsyspro','mdnmaster')}}' as etl_src_table_name
         ,'CMLSYSPRO'                                as source_system
    from {{source('cmlsyspro','mdnmaster')}}
)
,deduped as (
    select
        *,
        row_number() over (partition by dispatchnote,customer,customername order by _rivery_last_update desc) row_nbr
    from src
)
select
	dispatchnote,
	nextdetailline,
	salesorder,
	customer,
	customername,
	shippinginstrs,
	shippinginstrscod,
	specialinstrs,
	dispatchcomments1,
	dispatchcomments2,
	dispatchcomments3,
	dispatchcomments4,
	userfield1,
	userfield2,
	salesperson,
	branch,
	area,
	fixexchangerate,
	exchangerate,
	muldiv,
	currency,
	discpct1,
	discpct2,
	discpct3,
	ordertype,
	invtermsoverride,
	reprintformat,
	taxexemptflag,
	taxexemptoverride,
	ibtflag,
	dispatchname,
	planneddeliverdate,
	actualdeliverydate,
	shipaddressflag,
	customerponumber,
	companytaxno,
	invoice,
	invoicecreateddate,
	consolidateinvflag,
	taxexemptnumber,
	dispatchnotestatus,
	prevstatus,
	activeflag,
	reason,
	statuswhenheld,
	datelastinvprt,
	nationality,
	deliveryterms,
	transactionnature,
	transportmode,
	processflag,
	dispatchcustname,
	dispatchaddress1,
	dispatchaddress2,
	dispatchaddress3,
	dispatchaddrloc,
	dispatchaddress4,
	dispatchaddress5,
	dispatchpostalcode,
	dispatchgpslat,
	dispatchgpslong,
	state,
	countyzip,
	extendedtaxcode,
	multishipcode,
	webcreated,
	quote,
	quoteversion,
	gtrreference,
	lastoperator,
	email,
	creditauthority,
	tpmpickupflag,
	tpmevaluatedflag,
	standardcomment,
	detailstatus,
	salesordersource,
	salesordersrcdesc,
	languagecode,
	shippinglocation,
	timestamp,
	regimecode,
	portdispatch,
	pricegroup,
	pricegrouplevel,
	_rivery_river_id,
	_rivery_run_id,
	_rivery_last_update,
    etl_src_table_name,
 	source_system
from deduped
where row_nbr = 1